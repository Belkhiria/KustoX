{"version":3,"file":"managedStreamingIngestClient.js","sourceRoot":"","sources":["../../src/managedStreamingIngestClient.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\n\nimport { IngestionPropertiesInput } from \"./ingestionProperties.js\";\n\nimport { isNodeLike } from \"@azure/core-util\";\nimport { KustoConnectionStringBuilder, KustoResponseDataSet } from \"azure-kusto-data\";\nimport { Readable } from \"stream\";\nimport { AbstractKustoClient } from \"./abstractKustoClient.js\";\nimport { AbstractDescriptor, BlobDescriptor, StreamDescriptor } from \"./descriptors.js\";\nimport { FileDescriptor } from \"./fileDescriptor.js\";\nimport IngestClient from \"./ingestClient.js\";\nimport { ExponentialRetry } from \"./retry.js\";\nimport { readableToStream, tryFileToBuffer, tryStreamToArray } from \"./streamUtils.js\";\nimport StreamingIngestClient from \"./streamingIngestClient.js\";\nimport { IngestionResult } from \"./ingestionResult.js\";\n\nconst maxStreamSize = 1024 * 1024 * 4;\nconst attemptCount = 3;\nconst ingestPrefix = \"https://ingest-\";\n\nclass KustoManagedStreamingIngestClient extends AbstractKustoClient {\n    private streamingIngestClient: StreamingIngestClient;\n    private queuedIngestClient: IngestClient;\n    private baseSleepTimeSecs = 1;\n    private baseJitterSecs = 1;\n\n    /**\n     * Creates a KustoManagedStreamingIngestClient from a DM connection string.\n     * This method infers the engine connection string.\n     * For advanced usage, use the constructor that takes a DM connection string and an engine connection string.\n     *\n     * @param dmConnectionString The DM connection string.\n     * @param defaultProps The default ingestion properties.\n     */\n    static fromDmConnectionString(\n        dmConnectionString: KustoConnectionStringBuilder,\n        defaultProps?: IngestionPropertiesInput,\n    ): KustoManagedStreamingIngestClient {\n        if (dmConnectionString.dataSource == null || !dmConnectionString.dataSource.startsWith(ingestPrefix)) {\n            throw new Error(`DM connection string must include the prefix '${ingestPrefix}'`);\n        }\n\n        const engineConnectionString = KustoConnectionStringBuilder.fromExisting(dmConnectionString);\n        engineConnectionString.dataSource = engineConnectionString.dataSource?.replace(ingestPrefix, \"https://\");\n\n        return new KustoManagedStreamingIngestClient(engineConnectionString, dmConnectionString, defaultProps);\n    }\n\n    /**\n     * Creates a KustoManagedStreamingIngestClient from a engine connection string.\n     * This method infers the engine connection string.\n     * For advanced usage, use the constructor that takes an engine connection string and an engine connection string.\n     *\n     * @param engineConnectionString The engine connection string.\n     * @param defaultProps The default ingestion properties.\n     */\n    static fromEngineConnectionString(\n        engineConnectionString: KustoConnectionStringBuilder,\n        defaultProps?: IngestionPropertiesInput,\n    ): KustoManagedStreamingIngestClient {\n        if (engineConnectionString.dataSource == null || engineConnectionString.dataSource.startsWith(ingestPrefix)) {\n            throw new Error(`Engine connection string must not include the prefix '${ingestPrefix}'`);\n        }\n\n        const dmConnectionString = KustoConnectionStringBuilder.fromExisting(engineConnectionString);\n        dmConnectionString.dataSource = dmConnectionString.dataSource?.replace(\"https://\", ingestPrefix);\n\n        return new KustoManagedStreamingIngestClient(engineConnectionString, dmConnectionString, defaultProps);\n    }\n\n    constructor(\n        engineKcsb: string | KustoConnectionStringBuilder,\n        dmKcsb: string | KustoConnectionStringBuilder,\n        defaultProps?: IngestionPropertiesInput,\n        autoCorrectEndpoint: boolean = true,\n    ) {\n        super(defaultProps);\n        this.streamingIngestClient = new StreamingIngestClient(engineKcsb, defaultProps, autoCorrectEndpoint);\n        this.queuedIngestClient = new IngestClient(dmKcsb, defaultProps, autoCorrectEndpoint);\n\n        if (this.streamingIngestClient.defaultDatabase && this.streamingIngestClient.defaultDatabase !== this.queuedIngestClient.defaultDatabase) {\n            throw new Error(\n                `Default database for streaming ingest client (${this.streamingIngestClient.defaultDatabase}) must match default database for queued ingest client (${this.queuedIngestClient.defaultDatabase})`,\n            );\n        }\n\n        this.defaultDatabase = this.streamingIngestClient.defaultDatabase;\n    }\n\n    /**\n     * Use Readable for Node.js and ArrayBuffer in browser\n     */\n    async ingestFromStream(\n        stream: StreamDescriptor | Readable | ArrayBuffer,\n        ingestionProperties?: IngestionPropertiesInput,\n        clientRequestId?: string,\n    ): Promise<KustoResponseDataSet | IngestionResult> {\n        this.ensureOpen();\n        const props = this._getMergedProps(ingestionProperties);\n        let descriptor = stream instanceof StreamDescriptor ? stream : new StreamDescriptor(stream);\n        let result = isNodeLike ? await tryStreamToArray(descriptor.stream as Readable, maxStreamSize) : descriptor.stream;\n        descriptor = new StreamDescriptor(result).merge(descriptor);\n        let streamingResult: Promise<any> | null = null;\n        // tryStreamToArray returns a Buffer in NodeJS impl if stream size is small enouph\n        if ((isNodeLike && result instanceof Buffer) || !isNodeLike) {\n            streamingResult = await this.streamWithRetries(\n                isNodeLike ? (descriptor.size ?? 0) : (descriptor.stream as ArrayBuffer).byteLength,\n                descriptor,\n                props,\n                clientRequestId,\n                result,\n            );\n\n            result = isNodeLike ? readableToStream(result) : descriptor.stream;\n        }\n\n        return streamingResult ?? this.queuedIngestClient.ingestFromStream(new StreamDescriptor(result).merge(descriptor), props);\n    }\n\n    /**\n     * Use string for Node.js and Blob in browser\n     */\n    async ingestFromFile(\n        file: FileDescriptor | string | Blob,\n        ingestionProperties?: IngestionPropertiesInput,\n    ): Promise<KustoResponseDataSet | IngestionResult> {\n        this.ensureOpen();\n\n        const stream = file instanceof FileDescriptor ? await tryFileToBuffer(file) : await tryFileToBuffer(new FileDescriptor(file));\n        return await this.ingestFromStream(stream, ingestionProperties);\n    }\n\n    async ingestFromBlob(\n        blob: string | BlobDescriptor,\n        ingestionProperties?: IngestionPropertiesInput,\n        clientRequestId?: string,\n    ): Promise<KustoResponseDataSet | IngestionResult> {\n        const props = this._getMergedProps(ingestionProperties);\n        const descriptor = blob instanceof BlobDescriptor ? blob : new BlobDescriptor(blob);\n        // No need to check blob size if it was given to us that it's not empty\n        await descriptor.fillSize();\n\n        const streamingResult = await this.streamWithRetries(descriptor.size ?? 0, descriptor, props, clientRequestId);\n        return streamingResult ?? this.queuedIngestClient.ingestFromBlob(descriptor, props);\n    }\n\n    async streamWithRetries(\n        length: number,\n        descriptor: AbstractDescriptor,\n        props?: IngestionPropertiesInput,\n        clientRequestId?: string,\n        stream?: Readable | ArrayBuffer,\n    ): Promise<any> {\n        const isBlob = descriptor instanceof BlobDescriptor;\n        if (length <= maxStreamSize) {\n            // If we get buffer that means it was less than the max size, so we can do streamingIngestion\n            const retry = new ExponentialRetry(attemptCount, this.baseSleepTimeSecs, this.baseJitterSecs);\n            while (retry.shouldTry()) {\n                try {\n                    const sourceId =\n                        clientRequestId ??\n                        `KNC.executeManagedStreamingIngest${isBlob ? \"FromBlob\" : \"FromStream\"};${descriptor.sourceId};${retry.currentAttempt}`;\n                    if (isBlob) {\n                        return await this.streamingIngestClient.ingestFromBlob(descriptor as BlobDescriptor, props, sourceId);\n                    }\n\n                    if (isNodeLike) {\n                        return await this.streamingIngestClient.ingestFromStream(\n                            new StreamDescriptor(readableToStream(stream!)).merge(descriptor as StreamDescriptor),\n                            props,\n                            sourceId,\n                        );\n                    }\n\n                    return await this.streamingIngestClient.ingestFromStream(descriptor as StreamDescriptor, props, sourceId);\n                } catch (err: unknown) {\n                    const oneApiError = err as { \"@permanent\"?: boolean };\n                    if (oneApiError[\"@permanent\"]) {\n                        throw err;\n                    }\n                    await retry.backoff();\n                }\n            }\n\n            stream = isBlob ? undefined : isNodeLike && stream ? readableToStream(stream) : (descriptor as StreamDescriptor).stream;\n        }\n\n        return null;\n    }\n\n    close() {\n        if (!this._isClosed) {\n            this.streamingIngestClient.close();\n            this.queuedIngestClient.close();\n        }\n        super.close();\n    }\n}\n\nexport default KustoManagedStreamingIngestClient;\n"]}