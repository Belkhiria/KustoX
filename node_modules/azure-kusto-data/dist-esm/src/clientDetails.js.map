{"version":3,"file":"clientDetails.js","sourceRoot":"","sources":["../../src/clientDetails.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\n\nimport { isNode } from \"@azure/core-util\";\nimport { userInfo } from \"os\";\nimport { SDK_VERSION } from \"./version\";\n\n// eslint-disable-next-line @typescript-eslint/no-namespace,@typescript-eslint/no-unused-vars -- This is the correct way to augment the global namespace\ndeclare namespace NodeJS {\n    interface ProcessEnv {\n        npm_package_name?: string;\n        USERNAME?: string;\n        USERDOMAIN?: string;\n    }\n}\n\n// REPLACE_REGEX = re.compile(r\"[\\r\\n\\s{}|]+\")\nconst ReplaceRegex = /[\\r\\n\\s{}|]+/g;\nconst None = \"[none]\";\n\nexport class ClientDetails {\n    readonly versionForTracing: string;\n\n    constructor(public applicationNameForTracing: string | null, public userNameForTracing: string | null) {\n        if (this.applicationNameForTracing === null) {\n            this.applicationNameForTracing = ClientDetails.defaultApplication();\n        }\n        if (this.userNameForTracing === null) {\n            this.userNameForTracing = ClientDetails.defaultUser();\n        }\n        this.versionForTracing = ClientDetails.defaultVersion();\n    }\n\n    static defaultApplication(): string {\n        if (isNode) {\n            return process.env?.npm_package_name || process.title || None;\n        } else {\n            return window?.location?.href || None;\n        }\n    }\n\n    static defaultUser(): string {\n        if (isNode) {\n            let username: string | undefined;\n            try {\n                username = userInfo().username;\n            } catch (err: any) {\n                /* Ignore possible errors like \"uv_os_get_passwd returned ENOMEM\" that may occur in some environments. */\n\n                // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n                if (err.info?.code !== \"ENOMEM\") {\n                    throw err;\n                }\n            }\n\n            return username || (process.env.USERDOMAIN ? `${process.env.USERDOMAIN}\\\\${process.env.USERNAME}` : process.env.USERNAME) || None;\n        } else {\n            return None;\n        }\n    }\n\n    static defaultVersion(): string {\n        return this.formatHeader([\n            [\"Kusto.JavaScript.Client\", SDK_VERSION],\n            [\"Runtime.\" + (isNode ? \"Node\" : \"Browser\"), (isNode ? process.version : window?.navigator?.userAgent) || None],\n        ]);\n    }\n\n    static escapeHeader(header: string): string {\n        return `{${header.replace(ReplaceRegex, \"_\")}}`;\n    }\n\n    static formatHeader(args: [string, string][]): string {\n        return args\n            .filter(([key, val]) => key && val)\n            .map(([key, val]) => `${key}:${this.escapeHeader(val)}`)\n            .join(\"|\");\n    }\n\n    static setConnectorDetails(\n        name: string,\n        version: string,\n        app_name: string | null = null,\n        app_version: string | null = null,\n        send_user: boolean = false,\n        override_user: string | null = null,\n        additional_fields: [string, string][] | null = null\n    ): ClientDetails {\n        const params: [string, string][] = [[\"Kusto.\" + name, version]];\n\n        app_name = app_name || this.defaultApplication();\n        app_version = app_version || None;\n\n        params.push([\"App.\" + this.escapeHeader(app_name), app_version]);\n        params.push(...(additional_fields || []));\n\n        let user = None;\n\n        if (send_user) {\n            user = override_user || this.defaultUser();\n        }\n\n        return new ClientDetails(this.formatHeader(params), user);\n    }\n\n    getHeaders(): Partial<KustoHeaders> {\n        return {\n            \"x-ms-client-version\": this.versionForTracing,\n            \"x-ms-app\": this.applicationNameForTracing,\n            \"x-ms-user\": this.userNameForTracing,\n        };\n    }\n}\n\nexport interface KustoHeaders {\n    \"x-ms-client-version\": string | null;\n    \"x-ms-app\": string | null;\n    \"x-ms-user\": string | null;\n    \"x-ms-client-request-id\": string | null;\n}\n"]}